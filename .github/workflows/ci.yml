name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write

env:
  BUILD_TYPE: Release
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  # Job 1: Code Formatting Check (fast, runs in parallel with security-scan and build)
  format-check:
    name: Code Formatting
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install LLVM
      run: |
        if (Get-Command clang-format -ErrorAction SilentlyContinue) {
          Write-Host "‚úÖ LLVM already available"
        } else {
          Write-Host "Installing LLVM..."
          choco install llvm --no-progress
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
        }
        clang-format --version
        
    - name: Check code formatting
      run: |
        $files = Get-ChildItem -Path backend,frontend,src,Tests -Include *.cpp,*.h,*.hpp -Recurse -File
        $unformatted = @()
        
        foreach ($file in $files) {
          $result = clang-format --dry-run --Werror $file.FullName 2>&1
          if ($LASTEXITCODE -ne 0) {
            $unformatted += $file.FullName
            Write-Host "‚ùå $file needs formatting" -ForegroundColor Red
          }
        }
        
        if ($unformatted.Count -gt 0) {
          Write-Host "`nThe following files need formatting:" -ForegroundColor Red
          $unformatted | ForEach-Object { Write-Host "  $_" }
          exit 1
        }
        
        Write-Host "‚úÖ All files are properly formatted!" -ForegroundColor Green

  # Job 2: Security Scan (runs in parallel with format-check and build)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.24.0
      continue-on-error: true
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Job 3: Build (runs in parallel with format-check and security-scan)
  build:
    name: Build (Windows)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '4bb07a326d9b9bce3703272a509e5bc25dd9cfd5'
        
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          ${{github.workspace}}/vcpkg_installed
          ${{github.workspace}}/vcpkg
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-
          
    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build `
          -S ${{github.workspace}} `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake `
          -DVCPKG_TARGET_TRIPLET=x64-windows `
          -DVCPKG_INSTALLED_DIR=${{github.workspace}}/vcpkg_installed `
          -DBUILD_TESTS=ON `
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          
    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release --parallel

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: criptogualet-build
        path: |
          ${{github.workspace}}/build/Release/*.exe
          ${{github.workspace}}/build/Release/*.dll
          ${{github.workspace}}/build/compile_commands.json
        retention-days: 7

  # Job 4: Run Tests (uses CTest)
  test:
    name: Run Tests
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '4bb07a326d9b9bce3703272a509e5bc25dd9cfd5'
        
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          ${{github.workspace}}/vcpkg_installed
          ${{github.workspace}}/vcpkg
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-
          
    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build `
          -S ${{github.workspace}} `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake `
          -DVCPKG_TARGET_TRIPLET=x64-windows `
          -DVCPKG_INSTALLED_DIR=${{github.workspace}}/vcpkg_installed `
          -DBUILD_TESTS=ON `
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          
    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release --parallel
      
    - name: Configure CTest
      working-directory: ${{github.workspace}}/build
      run: |
        ctest -N
        Write-Host "`nTest discovery complete" -ForegroundColor Cyan
        
    - name: Run Tests with CTest
      working-directory: ${{github.workspace}}/build
      run: ctest --output-on-failure -C Release

  # Job 5: Static Analysis (separate job using compile_commands.json)
  static-analysis:
    name: Static Analysis
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: criptogualet-build
        path: ${{github.workspace}}/build
        
    - name: Install LLVM
      run: |
        if (Get-Command clang-tidy -ErrorAction SilentlyContinue) {
          Write-Host "‚úÖ clang-tidy already available"
        } else {
          Write-Host "Installing LLVM..."
          choco install llvm --no-progress
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
        }
        clang-tidy --version
        
    - name: Run Static Analysis
      run: |
        Write-Host "`nüîç Running static analysis with clang-tidy..." -ForegroundColor Cyan
        
        $workspace = "${{github.workspace}}"
        
        # Only analyze backend code (Qt frontend has complex dependencies)
        $files = Get-ChildItem -Path backend,src -Include *.cpp -Recurse -File | 
                Where-Object { 
                    $_.FullName -notmatch 'Tests' -and 
                    $_.FullName -notmatch 'build' -and 
                    $_.FullName -notmatch 'frontend' 
                } | Where-Object {
                    $content = Get-Content $_.FullName -Raw -ErrorAction SilentlyContinue
                    $content -notmatch '#include.*Qt'
                }
        
        $includes = @(
          "-I$workspace",
          "-I$workspace/backend",
          "-I$workspace/backend/blockchain/include",
          "-I$workspace/backend/core/include",
          "-I$workspace/backend/database/include",
          "-I$workspace/backend/repository/include",
          "-I$workspace/backend/utils/include",
          "-I$workspace/src"
        )
        
        $hasErrors = $false
        $errorCount = 0
        $totalFiles = 0
        
        foreach ($file in $files) {
          $totalFiles++
          Write-Host "Analyzing [$totalFiles]: $file" -ForegroundColor Gray
          
          $output = clang-tidy $file.FullName -p $workspace/build --config-file $workspace/.clang-tidy --quiet -- -std=c++20 $includes 2>&1 | 
                    Where-Object { $_ -notmatch 'vcpkg_installed' -and $_ -notmatch 'include[/\\]cpr' }
          
          $fileErrors = ($output | Select-String -Pattern "error:").Count
          $errorCount += $fileErrors
          if ($fileErrors -gt 0) {
            $hasErrors = $true
            Write-Host "‚ùå Found $fileErrors error(s) in $file" -ForegroundColor Red
            $output | Select-String -Pattern "error:" | ForEach-Object { Write-Host $_ -ForegroundColor Red }
          }
        }
        
        Write-Host "`n========================================" -ForegroundColor Yellow
        Write-Host "Files analyzed: $totalFiles" -ForegroundColor Cyan
        if ($hasErrors) {
          Write-Host "‚ùå Static analysis found $errorCount error(s)" -ForegroundColor Red
          exit 1
        } else {
          Write-Host "‚úÖ Static analysis passed!" -ForegroundColor Green
        }
        Write-Host "========================================" -ForegroundColor Yellow
